<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Course_work.Pages.NowTasksPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:conv="clr-namespace:Course_work.Converters"
    xmlns:models="clr-namespace:Course_work.Models"
    xmlns:pop="clr-namespace:Course_work.Pages.Popups"
    Title="Сегодняшние задачи"
    BackgroundColor="White">

    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:NullToBoolConverter x:Key="NullToBoolConverter" />
            <conv:PriorityToColorConverter x:Key="PriorityToColorConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>

        <VerticalStackLayout Padding="15">

            <!-- СПИСОК ЗАДАЧ -->
            <CollectionView x:Name="TasksList"
                            ItemsSource="{Binding TodayTasks}"
                            ItemsLayout="VerticalList"
                            SelectionMode="None">

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:TodoItem">

                        <Grid Padding="10"
                              Margin="0,0,0,10"
                              ColumnDefinitions="40, *">

                            <!-- КРУЖОК (завершение задачи) -->
                            <Ellipse
                                WidthRequest="28"
                                HeightRequest="28"
                                Stroke="{Binding Priority, Converter={StaticResource PriorityToColorConverter}}"
                                StrokeThickness="3"
                                Fill="Transparent">

                                <Ellipse.GestureRecognizers>
                                    <TapGestureRecognizer
                                        Command="{Binding Source={x:Reference TasksList}, Path=BindingContext.CompleteTaskCommand}"
                                        CommandParameter="{Binding .}" />
                                </Ellipse.GestureRecognizers>

                            </Ellipse>

                            <!-- ТАП НА ЗАДАЧУ (ОТКРЫТЬ POPUP) -->
                            <Grid Grid.Column="1">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer
                                        Command="{Binding Source={x:Reference TasksList}, Path=BindingContext.ShowTaskCommand}"
                                        CommandParameter="{Binding .}" />
                                </Grid.GestureRecognizers>

                                <VerticalStackLayout Spacing="4" Padding="12,0">

                                    <Label Text="{Binding Title}"
                                           FontSize="20"
                                           TextColor="#111" />

                                    <Label Text="{Binding Description}"
                                           FontSize="14"
                                           TextColor="#777777" />

                                    <Label Text="{Binding Time, StringFormat='{0:hh\\:mm}'}"
                                           FontSize="13"
                                           TextColor="#5A5A5A"
                                           IsVisible="{Binding Time, Converter={StaticResource NullToBoolConverter}}" />

                                </VerticalStackLayout>

                            </Grid>

                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

            </CollectionView>

        </VerticalStackLayout>

        <!-- ВСПЛЫВАЮЩЕЕ ОКНО -->
        <pop:ViewTaskPopup x:Name="TaskPopup"
                           IsVisible="False"
                           HorizontalOptions="Fill"
                           VerticalOptions="Fill"/>

    </Grid>

</ContentPage>